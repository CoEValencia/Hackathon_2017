[{"id":"a287d644.75d4c8","type":"ibmiot in","z":"f12256d.20c8aa8","authentication":"apiKey","apiKey":"30376bc0.dc5004","inputType":"evt","deviceId":"kinectDeviceOVI","applicationId":"","deviceType":"kinectDeviceType","eventType":"kinectEvent","commandType":"","format":"json","name":"IBM IoT Input","service":"registered","allDevices":false,"allApplications":"","allDeviceTypes":true,"allEvents":true,"allCommands":"","allFormats":true,"qos":0,"x":90,"y":440,"wires":[["4f8159d4.39fd18"]]},{"id":"19999cda.163a53","type":"ibmiot in","z":"f12256d.20c8aa8","authentication":"boundService","apiKey":"","inputType":"appsts","deviceId":"","applicationId":"","deviceType":"+","eventType":"+","commandType":"","format":"json","name":"IBM IoT App Initialize Context","service":"registered","allDevices":false,"allApplications":false,"allDeviceTypes":true,"allEvents":true,"allCommands":false,"allFormats":false,"qos":"0","x":188,"y":155,"wires":[["5f8b892a.21a078"]]},{"id":"edb04af9.5e6988","type":"comment","z":"f12256d.20c8aa8","name":"Context Definition","info":"","x":431,"y":109,"wires":[]},{"id":"5f8b892a.21a078","type":"function","z":"f12256d.20c8aa8","name":"Global Configure ","func":"\n/**\n * Funci�n que inicializa todas las propiedades de la aplicaci�n\n **/\nfunction InitializeConfigure() {\n    this.context.global.set(\"isDebug\",false);\n    this.context.global.set(\"timeDelay\",2000);\n    this.context.global.set(\"numPackets\",1);\n    this.context.global.set(\"numPacketsDebug\",1);\n    return msg;\n}\n\n\nInitializeConfigure();","outputs":1,"noerr":0,"x":432.2142333984375,"y":155.35715293884277,"wires":[[]]},{"id":"4f8159d4.39fd18","type":"switch","z":"f12256d.20c8aa8","name":"Validate Packet","property":"payload","propertyType":"msg","rules":[{"t":"null"},{"t":"nnull"}],"checkall":"true","outputs":2,"x":282.9999809265137,"y":586.0000438690186,"wires":[[],["c988ca5a.42f358"]]},{"id":"711032ff.d2336c","type":"function","z":"f12256d.20c8aa8","name":"Deserializacion Body Parts","func":"function toDecimal(input, decimals){\n  var res =  parseFloat(Math.round(input * 100) / 100).toFixed(decimals);\n  //node.warn(res);\n  return res;\n}\n\nnode.warn(msg.payload)\nvar obj = msg.payload;\nvar user = obj.user;\nvar size = user.length;\n//node.warn(size);\nvar numDecimals = this.context.global.get(\"numDecimals\");\nvar users = [];\nif (user) {\n  for (var i = 0; i < user.length; i++)\n  {\n    var bodypart = context.global.get(\"bodyPartSelect\");\n    //node.warn(bodypart);\n    //node.warn(user)\n    if (user[i])\n      var body = user[i].bodyParts;\n    //node.warn(body);\n    var myBodyParts = [];\n    if(body){\n\n      body.forEach(\n        function(p){\n\n          var item;\n          if(p.name == \"Neck\") {\n\n            p.positions[0].x = toDecimal(p.positions[0].x, numDecimals);\n            p.positions[0].y = toDecimal(p.positions[0].y, numDecimals);\n            p.positions[0].z = toDecimal(p.positions[0].z, numDecimals);\n\n            item = p;\n            item.userId = i+1;\n            // node.warn(item);\n            //node.send(item);\n          }\n          else if (p.name == \"WristLeft\"){\n            p.positions[0].x = toDecimal(p.positions[0].x, numDecimals);\n            p.positions[0].y = toDecimal(p.positions[0].y, numDecimals);\n            p.positions[0].z = toDecimal(p.positions[0].z, numDecimals);\n\n            item = p;\n            item.userId = i+1;\n            // node.warn(item);\n            //node.send(item);\n          }\n          else if (p.name == \"WristRight\"){\n            p.positions[0].x = toDecimal(p.positions[0].x, numDecimals);\n            p.positions[0].y = toDecimal(p.positions[0].y, numDecimals);\n            p.positions[0].z = toDecimal(p.positions[0].z, numDecimals);\n\n            item = p;\n            item.userId = i+1;\n            // node.warn(item);\n            //node.send(item);\n          }\n          if (item){\n            myBodyParts.push(item);\n          }\n        }\n      );\n    }\n    var userElement = {\"id\": i+1, parts: myBodyParts};\n    users.push(userElement)\n  }\n  msg.users = users;\n  return msg;\n}\n","outputs":1,"noerr":0,"x":549.1243743896484,"y":446.79601287841797,"wires":[["c3d43d3a.5c66c","4c0aa1f0.d0dd4"]],"outputLabels":["string"]},{"id":"c3d43d3a.5c66c","type":"function","z":"f12256d.20c8aa8","name":"Usuario 0","func":"var users = msg.users;\n\nmsg.user = users[0];\nreturn msg;","outputs":1,"noerr":0,"x":820,"y":580,"wires":[["586ddb92.6a4de4"]]},{"id":"4c0aa1f0.d0dd4","type":"function","z":"f12256d.20c8aa8","name":"Usuario 1","func":"var users = msg.users;\n\nmsg.user = users[1];\nreturn msg;","outputs":1,"noerr":0,"x":774.1811790466309,"y":265.7308883666992,"wires":[["586ddb92.6a4de4"]]},{"id":"586ddb92.6a4de4","type":"function","z":"f12256d.20c8aa8","name":"Untitled Theme 1","func":"var user = msg.user;\nvar wristLeft = user.parts[1];\nvar wristRight = user.parts[2];\nvar neck = msg.user.parts[0];\n//node.warn(user)\nvar mediumWristles = {x: (parseFloat(wristLeft.positions[0].x) + parseFloat(wristRight.positions[0].x)) / 2, y: (parseFloat(wristLeft.positions[0].y) + parseFloat(wristRight.positions[0].y)) / 2}\nnode.warn(mediumWristles)\nvar neck = { x: (parseFloat(neck.positions[0].x)), y:(parseFloat(neck.positions[0].y)) }\n//node.warn(neck)\nvar distance = { x: mediumWristles.x - neck.x, y: mediumWristles.y - neck.y };\n\n\nvar userDistance = { userId: user.id, distance: distance };\nmsg.userDistance = userDistance;\n//node.warn(msg.userDistance)\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":400,"wires":[["841e84e7.529238"]]},{"id":"815cc72d.3547a8","type":"function","z":"f12256d.20c8aa8","name":"Chargue","func":"var userDistance = msg.userDistance;\nvar idealPoint = {x: 0.0, y: 0.2}\nvar difference = {x: idealPoint.x - userDistance.distance.x, y: idealPoint.y - userDistance.distance.y}\nvar distance = {name: \"Charge\", distance: Math.sqrt(Math.pow(difference.x,2) + Math.pow(difference.y,2)), userId: userDistance.userId}\n\nif(distance.distance < msg.parts.distance)\n    msg.parts = distance;\nnode.warn(\"Charge: \" + userDistance.userId + \" : \" + distance)\n\nreturn msg;","outputs":1,"noerr":0,"x":1237.6808395385742,"y":603.3745021820068,"wires":[["ff59e4b8.56dd28"]]},{"id":"8a40e742.fc3908","type":"function","z":"f12256d.20c8aa8","name":"Shoot","func":"var userDistance = msg.userDistance;\nvar idealPointLeft = {x: -0.5, y: 0.0}\nvar idealPointRight = {x: 0.5, y: 0.0}\n\nvar differenceLeft = {x: idealPointLeft.x - userDistance.distance.x, y: idealPointLeft.y - userDistance.distance.y}\nvar differenceRight = {x: idealPointRight.x - userDistance.distance.x, y: idealPointRight.y - userDistance.distance.y}\n\nvar distanceLeft = Math.sqrt(Math.pow(differenceLeft.x,2) + Math.pow(differenceLeft.y,2))\nvar distanceRight = Math.sqrt(Math.pow(differenceRight.x,2) + Math.pow(differenceRight.y,2))\n\nvar distance = {name: \"Shoot\", distance: Math.min(distanceLeft, distanceRight), userId: userDistance.userId}\n\nif(distance.distance < msg.parts.distance)\n    msg.parts = distance;\nnode.warn(\"Shoot: \" + userDistance.userId + \" : \" + distance)\nreturn msg;","outputs":1,"noerr":0,"x":1234.3386573791504,"y":419.54408264160156,"wires":[["815cc72d.3547a8"]]},{"id":"841e84e7.529238","type":"function","z":"f12256d.20c8aa8","name":"Shield","func":"var userDistance = msg.userDistance;\nvar idealPoint = {x: 0.0, y: 0.0}\nvar difference = {x: idealPoint.x - userDistance.distance.x, y: idealPoint.y - userDistance.distance.y}\nvar distance = {name: \"Shield\", distance: Math.sqrt(Math.pow(difference.x,2) + Math.pow(difference.y,2)), userId: userDistance.userId}\n\nmsg.parts = distance;\nnode.warn(\"Shield \" + userDistance.userId + \" : \" + distance)\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1174.0052947998047,"y":227.8715476989746,"wires":[["8a40e742.fc3908"]]},{"id":"c988ca5a.42f358","type":"function","z":"f12256d.20c8aa8","name":"Throttling","func":"var packetId = msg.payload.packetID;\n\n//if(packetId % this.context.global.get(\"numPacketsDebug\") == 0)  \n  //  node.warn(packetId);\n\nif(packetId % 100 == 0)  \n    return node.send(msg);\n\n\n\n","outputs":1,"noerr":0,"x":304.01737213134766,"y":443.7882604598999,"wires":[["711032ff.d2336c"]]},{"id":"a73cb7c0.056698","type":"function","z":"f12256d.20c8aa8","name":"Wait for all tasks to finish","func":"context.data = context.data || new Object();\nnode.warn(msg)\nswitch (msg.parts.name) {\n    case \"Shield\":\n        context.data.shield = msg.parts.distance;\n        msg = null;\n        break;\n    case \"Shoot\":\n        context.data.shoot = msg.parts.distance;\n        msg = null;\n        break;\n    case \"Charge\":\n        context.data.charge = msg.parts.distance;\n        msg = null;\n        break;\n    default:\n        msg = null;\n    \tbreak;\n}\n\nnode.warn(context.data)\n\n\nif(context.data.shield < context.data.shoot && context.data.shield < context.data.charge){\n    var result = {userId: msg.parts.userId, action: \"Shield\"};\n}\n\nelse if(context.data.shoot < context.data.charge){\n    var result = {userId: msg.parts.userId, action: \"Shoot\"};\n}\nelse {\n    var result = {userId: msg.parts.userId, action: \"Charge\"};\n}\n\nreturn result;\n\n","outputs":1,"noerr":0,"x":1436.0173568725586,"y":146.01042556762695,"wires":[[]]},{"id":"ff59e4b8.56dd28","type":"function","z":"f12256d.20c8aa8","name":"","func":"node.warn(msg.parts)\nnode.warn(msg)\nmsg.payload.parts = msg.parts\nreturn msg;","outputs":1,"noerr":0,"x":1416.1910552978516,"y":609.0903091430664,"wires":[["e224266c.2ae2c8","4ab91705.b40698"]]},{"id":"c7d88912.c33968","type":"template","z":"f12256d.20c8aa8","name":"","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<html>\n\n<head>\n    <style>\n        body {\n            background: url(https://s3.envato.com/files/165244545/background.jpg);\n        }\n\n        canvas {\n            height: 100%;\n            width: 49%;\n            border: 1px solid #000000;\n        }\n    </style>\n</head>\n\n<body>\n    <img id=\"fondo\" src=\"https://s3.envato.com/files/165244545/background.jpg\" style=\"display: none\" />\n    <img id=\"bullet\" src=\"https://image.flaticon.com/icons/png/128/224/224679.png\" style=\"display:none\" />\n    <img id=\"heart\" src=\"https://images.emojiterra.com/emojione/v3/128px/2764.png\" style=\"display:none\" />\n    <img id=\"shield\" src=\"https://maxcdn.icons8.com/Share/icon/Military//knight_shield1600.png\" style=\"display: none\" />\n    <img id=\"bang\" src=\"https://i.imgur.com/JuYBzFD.png\" style=\"display:none\" />\n\n    <canvas id=\"player1\"></canvas>\n    <canvas id=\"player2\"></canvas>\n\n\n\n\n\n    <script>\n        var loc = window.location;\n        if (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n        // This needs to point to the web socket in the Node-RED flow\n        // ... in this case it's ws/simple\n        wsUri += \"//\" + loc.host + loc.pathname.replace(\"page\", \"ws/socket\");\n        let ws = new WebSocket(wsUri);\n\n\n        let canvas1 = document.getElementById(\"player1\");\n        let canvas2 = document.getElementById(\"player2\");\n\n        let game = new Game(canvas1, canvas2);\n\n        ws.onmessage = function (s) {\n            let action = JSON.parse(s.data).parts;\n\n            if (action.userId == 1) {\n                game.player1.setAction(action.name);\n            } else\n                game.player2.setAction(action.name);\n\n        }\n\n        game.play();\n\n       \n\n        function Game(canvas1, canvas2) {\n            this.player1 = new Player(canvas1);\n            this.player2 = new Player(canvas2);\n\n            this.update = function () {\n                this.player1.show();\n                this.player2.show();\n            }\n\n\n            this.play = async function () {\n               while (this.player1.isAlive() && this.player2.isAlive()) {\n                    while (!this.player1.action || !this.player2.action) {\n                        this.update();\n                        await sleep(1000);\n                    }\n\n                    console.log(this.player2.action)\n                    console.log(this.player1.action)\n                    switch (this.player1.action) {\n                        case 'Shoot':\n                            this.player1.shoot();\n                            if (this.player2.action != 'Shield')\n                            this.player2.hitted();\n                            \n                                this.update();\n                            break;\n                        case 'Shield':\n                            this.player1.shield();\n                            this.update();\n                            break;\n                        case 'Charge':\n                            this.player1.reload();\n                            this.update();\n                            break;\n                    }\n                    switch (this.player2.action) {\n                        case 'Shoot':\n                            this.player2.shoot();\n                            if (this.player1.action != 'Shield')\n                               this.player1.hitted();\n                                this.update();\n                            break;\n                        case 'Shield':\n                        this.player2.shield();\n                            this.update();\n                            break;\n                        case 'Charge':\n                        this.player2.reload();\n                            this.update();\n                            break;\n                    }\n                    this.update();\n\n                    this.player1.action = undefined;\n                    this.player2.action = undefined;\n\n                    sleep(1500);\n\n                }\n                if(this.player1.isAlive())\n                    alert(\"Gana el jugador 1\");\n                else\n                    alert(\"Gana el jugador 2\");\n            }\n\n            function sleep(ms) {\n                return new Promise(resolve => setTimeout(resolve, ms));\n            }\n\n\n        }\n\n\n        function Player(canvas) {\n            this.bullets = [new Bullet(0), new Bullet(20), new Bullet(40)];\n            this.lifes = [new Life(canvas.width - 50), new Life(canvas.width - 100), new Life(canvas.width - 150)];\n            this.ctx = canvas.getContext(\"2d\");\n            this.bang = new Bang();\n            this.escudo = new Shield(this.ctx);\n            this.action;\n\n            this.show = function () {\n                for (let bullet of this.bullets) {\n                    bullet.show(this.ctx);\n                }\n\n                for (let life of this.lifes) {\n                    life.show(this.ctx)\n                }\n            }\n\n            this.show();\n\n            this.hitted = function () {\n                if (this.lifes.length <= 0) {\n                    alert(\"Has perdido\");\n                    return;\n                }\n                this.lifes[this.lifes.length - 1].remove(this.ctx);\n                this.lifes.splice(this.lifes.length - 1, 1);\n                this.show();\n            }\n\n            this.reload = function () {\n                if (this.bullets.length >= 5)\n                    return;\n\n                this.bullets.push(new Bullet(this.bullets.length * 20))\n                this.show();\n            }\n\n            this.shoot = function () {\n                if (this.bullets.length <= 0) {\n                    return;\n                }\n\n                this.bang.show(this.ctx);\n                this.bullets[this.bullets.length - 1].remove(this.ctx);\n                this.bullets.splice(this.bullets.length - 1, 1);\n                this.show();\n\n            }\n\n            this.shield = function () {\n                this.escudo.show();\n            }\n\n            this.isAlive = function () {\n                return this.lifes.length > 0;\n            }\n\n            this.setAction = function (action) {\n                this.action = action;\n            }\n        }\n\n\n        function Bullet(x) {\n            this.x = x;\n            this.y = 5;\n            this.bulletImg = document.getElementById(\"bullet\");\n\n\n            this.show = function (ctx) {\n                ctx.drawImage(this.bulletImg, this.x, this.y, this.bulletImg.width * 0.3, this.bulletImg.height * 0.1);\n            }\n\n            this.remove = function (ctx) {\n                let img = ctx.createImageData(this.bulletImg.width * 0.3, this.bulletImg.height * 0.1);\n                for (let i = img.data.length; --i >= 0;) {\n                    img.data[i] = 0;\n                }\n                ctx.putImageData(img, this.x, this.y);\n            }\n        }\n\n        function Life(x) {\n            this.x = x;\n            this.y = 5;\n            this.heartImg = document.getElementById(\"heart\");\n\n            this.show = function (ctx) {\n                ctx.drawImage(this.heartImg, this.x, this.y, this.heartImg.width * 0.3, this.heartImg.height * 0.1);\n            }\n\n            this.remove = function (ctx) {\n                let img = ctx.createImageData(this.heartImg.width * 0.3, this.heartImg.height * 0.1);\n                for (let i = img.data.length; --i >= 0;) {\n                    img.data[i] = 0;\n                }\n                ctx.putImageData(img, this.x, this.y);\n            }\n        }\n\n        function Bang() {\n            this.bangImg = document.getElementById(\"bang\");\n            this.x = 80;\n            this.y = 20;\n\n            this.show = async function (ctx) {\n                ctx.drawImage(this.bangImg, this.x, this.y, this.bangImg.height * 0.3, this.bangImg.width * 0.3);\n                await sleep(3000);\n\n                this.remove(ctx);\n            }\n\n            function sleep(ms) {\n                return new Promise(resolve => setTimeout(resolve, ms));\n            }\n\n            this.remove = function (ctx) {\n                let img = ctx.createImageData(this.bangImg.width * 0.3, this.bangImg.height * 0.3);\n                for (let i = img.data.length; --i >= 0;) {\n                    img.data[i] = 0;\n                }\n                ctx.putImageData(img, this.x, this.y);\n            }\n        }\n\n        function Shield(ctx) {\n            this.x = 60;\n            this.y = 40;\n            this.shieldImage = document.getElementById(\"shield\");\n\n            this.show = async function () {\n                ctx.drawImage(this.shieldImage, this.x, this.y, this.shieldImage.width * 0.1, this.shieldImage.height * 0.05);\n                await sleep(2000);\n                this.remove(ctx);\n            }\n\n            function sleep(ms) {\n                return new Promise(resolve => setTimeout(resolve, ms));\n            }\n\n            this.remove = function (ctx) {\n                let img = ctx.createImageData(this.shieldImage.width * 0.3, this.shieldImage.height * 0.1);\n                for (let i = img.data.length; --i >= 0;) {\n                    img.data[i] = 0;\n                }\n                ctx.putImageData(img, this.x, this.y);\n            }\n        }\n\n\n\n    </script>\n</body>\n\n\n</html>","output":"str","x":1290,"y":760,"wires":[["c393d6ff.e4a818"]]},{"id":"e198c43.c694138","type":"http in","z":"f12256d.20c8aa8","name":"","url":"/page","method":"get","upload":false,"swaggerDoc":"","x":1042.5,"y":731.5,"wires":[["c7d88912.c33968"]]},{"id":"c393d6ff.e4a818","type":"http response","z":"f12256d.20c8aa8","name":"","statusCode":"","headers":{},"x":1526.2500228881836,"y":761.5000104904175,"wires":[]},{"id":"e224266c.2ae2c8","type":"websocket out","z":"f12256d.20c8aa8","name":"socket","server":"f45c5a3e.fb9798","client":"","x":1670,"y":460,"wires":[]},{"id":"4ab91705.b40698","type":"delay","z":"f12256d.20c8aa8","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1589,"y":596,"wires":[[]]},{"id":"30376bc0.dc5004","type":"ibmiot","z":"","name":"iot key Hackathon","keepalive":"60","serverName":"","cleansession":true,"appId":"","shared":true},{"id":"f45c5a3e.fb9798","type":"websocket-listener","z":"","path":"/ws/socket","wholemsg":"false"}]
